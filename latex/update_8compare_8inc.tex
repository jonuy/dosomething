\hypertarget{update_8compare_8inc}{
\section{html/modules/update/update.compare.inc File Reference}
\label{update_8compare_8inc}\index{html/modules/update/update.compare.inc@{html/modules/update/update.compare.inc}}
}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{update_8compare_8inc_a7e1ea49d91f2d2b81b8101d481d10300}{update\_\-get\_\-projects} ()
\item 
\hyperlink{update_8compare_8inc_a37eb8774bbb961b5d1113c116aba2f3b}{\_\-update\_\-process\_\-info\_\-list} (\&\$projects, \$list, \$project\_\-type, \$status)
\item 
\hyperlink{update_8compare_8inc_a02c561b213ab3df2e929917736dc2b7b}{update\_\-get\_\-project\_\-name} (\$file)
\item 
\hyperlink{update_8compare_8inc_ad14173209d3e9cf76fbd6d6d1977de05}{update\_\-process\_\-project\_\-info} (\&\$projects)
\item 
\hyperlink{update_8compare_8inc_aa0663304dc4634e4109c896f214ea791}{update\_\-calculate\_\-project\_\-data} (\$available)
\item 
\hyperlink{update_8compare_8inc_a964a0180687773bb39b53482d7106545}{update\_\-calculate\_\-project\_\-update\_\-status} (\$project, \&\$project\_\-data, \$available)
\item 
\hyperlink{update_8compare_8inc_a958705ecce49b020722280decff3f644}{update\_\-project\_\-cache} (\$cid)
\item 
\hyperlink{update_8compare_8inc_a8d1c29cf668adf2ea2a1a34f0f716cd1}{update\_\-filter\_\-project\_\-info} (\$info)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Code required only when comparing available updates to existing data. 

\subsection{Function Documentation}
\hypertarget{update_8compare_8inc_a37eb8774bbb961b5d1113c116aba2f3b}{
\index{update.compare.inc@{update.compare.inc}!\_\-update\_\-process\_\-info\_\-list@{\_\-update\_\-process\_\-info\_\-list}}
\index{\_\-update\_\-process\_\-info\_\-list@{\_\-update\_\-process\_\-info\_\-list}!update.compare.inc@{update.compare.inc}}
\subsubsection[{\_\-update\_\-process\_\-info\_\-list}]{\setlength{\rightskip}{0pt plus 5cm}\_\-update\_\-process\_\-info\_\-list (\&\$ {\em projects}, \/  \$ {\em list}, \/  \$ {\em project\_\-type}, \/  \$ {\em status})}}
\label{update_8compare_8inc_a37eb8774bbb961b5d1113c116aba2f3b}
Populates an array of project data.

This iterates over a list of the installed modules or themes and groups them by project and status. A few parts of this function assume that enabled modules and themes are always processed first, and if disabled modules or themes are being processed (there is a setting to control if disabled code should be included or not in the 'Available updates' report), those are only processed after \$projects has been populated with information about the enabled code. Modules and themes set as hidden are always ignored. This function also records the latest change time on the .info files for each module or theme, which is important data which is used when deciding if the cached available update data should be invalidated.


\begin{DoxyParams}{Parameters}
\item[{\em \$projects}]Reference to the array of project data of what's installed on this site. \item[{\em \$list}]Array of data to process to add the relevant info to the \$projects array. \item[{\em \$project\_\-type}]The kind of data in the list. Can be 'module' or 'theme'. \item[{\em \$status}]Boolean that controls what status (enabled or disabled) to process out of the \$list and add to the \$projects array.\end{DoxyParams}
\begin{DoxySeeAlso}{See also}
\hyperlink{update_8compare_8inc_a7e1ea49d91f2d2b81b8101d481d10300}{update\_\-get\_\-projects()} 
\end{DoxySeeAlso}
\hypertarget{update_8compare_8inc_aa0663304dc4634e4109c896f214ea791}{
\index{update.compare.inc@{update.compare.inc}!update\_\-calculate\_\-project\_\-data@{update\_\-calculate\_\-project\_\-data}}
\index{update\_\-calculate\_\-project\_\-data@{update\_\-calculate\_\-project\_\-data}!update.compare.inc@{update.compare.inc}}
\subsubsection[{update\_\-calculate\_\-project\_\-data}]{\setlength{\rightskip}{0pt plus 5cm}update\_\-calculate\_\-project\_\-data (\$ {\em available})}}
\label{update_8compare_8inc_aa0663304dc4634e4109c896f214ea791}
Calculates the current update status of all projects on the site.

The results of this function are expensive to compute, especially on sites with lots of modules or themes, since it involves a lot of comparisons and other operations. Therefore, we cache the results into the \{cache\_\-update\} table using the 'update\_\-project\_\-data' cache ID. However, since this is not the data about available updates fetched from the network, it is ok to invalidate it somewhat quickly. If we keep this data for very long, site administrators are more likely to see incorrect results if they upgrade to a newer version of a module or theme but do not visit certain pages that automatically clear this cache.


\begin{DoxyParams}{Parameters}
\item[{\em array}]\$available Data about available project releases.\end{DoxyParams}
\begin{DoxyReturn}{Returns}
An array of installed projects with current update status information.
\end{DoxyReturn}
\begin{DoxySeeAlso}{See also}
\hyperlink{update_8module_a683663ab0739a0d67fe3eb98f532c11c}{update\_\-get\_\-available()} 

\hyperlink{update_8compare_8inc_a7e1ea49d91f2d2b81b8101d481d10300}{update\_\-get\_\-projects()} 

\hyperlink{update_8compare_8inc_ad14173209d3e9cf76fbd6d6d1977de05}{update\_\-process\_\-project\_\-info()} 

\hyperlink{update_8compare_8inc_a958705ecce49b020722280decff3f644}{update\_\-project\_\-cache()} 
\end{DoxySeeAlso}
\hypertarget{update_8compare_8inc_a964a0180687773bb39b53482d7106545}{
\index{update.compare.inc@{update.compare.inc}!update\_\-calculate\_\-project\_\-update\_\-status@{update\_\-calculate\_\-project\_\-update\_\-status}}
\index{update\_\-calculate\_\-project\_\-update\_\-status@{update\_\-calculate\_\-project\_\-update\_\-status}!update.compare.inc@{update.compare.inc}}
\subsubsection[{update\_\-calculate\_\-project\_\-update\_\-status}]{\setlength{\rightskip}{0pt plus 5cm}update\_\-calculate\_\-project\_\-update\_\-status (\$ {\em project}, \/  \&\$ {\em project\_\-data}, \/  \$ {\em available})}}
\label{update_8compare_8inc_a964a0180687773bb39b53482d7106545}
Calculates the current update status of a specific project.

This function is the heart of the update status feature. For each project it is invoked with, it first checks if the project has been flagged with a special status like \char`\"{}unsupported\char`\"{} or \char`\"{}insecure\char`\"{}, or if the project node itself has been unpublished. In any of those cases, the project is marked with an error and the next project is considered.

If the project itself is valid, the function decides what major release series to consider. The project defines what the currently supported major versions are for each version of core, so the first step is to make sure the current version is still supported. If so, that's the target version. If the current version is unsupported, the project maintainer's recommended major version is used. There's also a check to make sure that this function never recommends an earlier release than the currently installed major version.

Given a target major version, the available releases are scanned looking for the specific release to recommend (avoiding beta releases and development snapshots if possible). For the target major version, the highest patch level is found. If there is a release at that patch level with no extra (\char`\"{}beta\char`\"{}, etc.), then the release at that patch level with the most recent release date is recommended. If every release at that patch level has extra (only betas), then the latest release from the previous patch level is recommended. For example:


\begin{DoxyItemize}
\item 1.6-\/bugfix $<$-\/-\/ recommended version because 1.6 already exists.
\item 1.6
\end{DoxyItemize}

or


\begin{DoxyItemize}
\item 1.6-\/beta
\item 1.5 $<$-\/-\/ recommended version because no 1.6 exists.
\item 1.4
\end{DoxyItemize}

Also, the latest release from the same major version is looked for, even beta releases, to display to the user as the \char`\"{}Latest version\char`\"{} option. Additionally, the latest official release from any higher major versions that have been released is searched for to provide a set of \char`\"{}Also available\char`\"{} options.

Finally, and most importantly, the release history continues to be scanned until the currently installed release is reached, searching for anything marked as a security update. If any security updates have been found between the recommended release and the installed version, all of the releases that included a security fix are recorded so that the site administrator can be warned their site is insecure, and links pointing to the release notes for each security update can be included (which, in turn, will link to the official security announcements for each vulnerability).

This function relies on the fact that the .xml release history data comes sorted based on major version and patch level, then finally by release date if there are multiple releases such as betas from the same major.patch version (e.g., 5.x-\/1.5-\/beta1, 5.x-\/1.5-\/beta2, and 5.x-\/1.5). Development snapshots for a given major version are always listed last.


\begin{DoxyParams}{Parameters}
\item[{\em \$project}]An array containing information about a specific project. \item[{\em \$project\_\-data}]An array containing information about a specific project. \item[{\em \$available}]Data about available project releases of a specific project. \end{DoxyParams}
\hypertarget{update_8compare_8inc_a8d1c29cf668adf2ea2a1a34f0f716cd1}{
\index{update.compare.inc@{update.compare.inc}!update\_\-filter\_\-project\_\-info@{update\_\-filter\_\-project\_\-info}}
\index{update\_\-filter\_\-project\_\-info@{update\_\-filter\_\-project\_\-info}!update.compare.inc@{update.compare.inc}}
\subsubsection[{update\_\-filter\_\-project\_\-info}]{\setlength{\rightskip}{0pt plus 5cm}update\_\-filter\_\-project\_\-info (\$ {\em info})}}
\label{update_8compare_8inc_a8d1c29cf668adf2ea2a1a34f0f716cd1}
Filters the project .info data to only save attributes we need.


\begin{DoxyParams}{Parameters}
\item[{\em array}]\$info Array of .info file data as returned by \hyperlink{common_8inc_a277955232059631211fcfde533ea89d6}{drupal\_\-parse\_\-info\_\-file()}.\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Array of .info file data we need for the update manager.
\end{DoxyReturn}
\begin{DoxySeeAlso}{See also}
\hyperlink{update_8compare_8inc_a37eb8774bbb961b5d1113c116aba2f3b}{\_\-update\_\-process\_\-info\_\-list()} 
\end{DoxySeeAlso}
\hypertarget{update_8compare_8inc_a02c561b213ab3df2e929917736dc2b7b}{
\index{update.compare.inc@{update.compare.inc}!update\_\-get\_\-project\_\-name@{update\_\-get\_\-project\_\-name}}
\index{update\_\-get\_\-project\_\-name@{update\_\-get\_\-project\_\-name}!update.compare.inc@{update.compare.inc}}
\subsubsection[{update\_\-get\_\-project\_\-name}]{\setlength{\rightskip}{0pt plus 5cm}update\_\-get\_\-project\_\-name (\$ {\em file})}}
\label{update_8compare_8inc_a02c561b213ab3df2e929917736dc2b7b}
Determines what project a given file object belongs to.


\begin{DoxyParams}{Parameters}
\item[{\em \$file}]A file object as returned by \hyperlink{system_8module_a0851ffa40e4bc737b29677e9b397caac}{system\_\-get\_\-files\_\-database()}.\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The canonical project short name.
\end{DoxyReturn}
\begin{DoxySeeAlso}{See also}
\hyperlink{system_8module_a0851ffa40e4bc737b29677e9b397caac}{system\_\-get\_\-files\_\-database()} 
\end{DoxySeeAlso}
\hypertarget{update_8compare_8inc_a7e1ea49d91f2d2b81b8101d481d10300}{
\index{update.compare.inc@{update.compare.inc}!update\_\-get\_\-projects@{update\_\-get\_\-projects}}
\index{update\_\-get\_\-projects@{update\_\-get\_\-projects}!update.compare.inc@{update.compare.inc}}
\subsubsection[{update\_\-get\_\-projects}]{\setlength{\rightskip}{0pt plus 5cm}update\_\-get\_\-projects ()}}
\label{update_8compare_8inc_a7e1ea49d91f2d2b81b8101d481d10300}
Fetches an array of installed and enabled projects.

This is only responsible for generating an array of projects (taking into account projects that include more than one module or theme). Other information like the specific version and install type (official release, dev snapshot, etc) is handled later in \hyperlink{update_8compare_8inc_ad14173209d3e9cf76fbd6d6d1977de05}{update\_\-process\_\-project\_\-info()} since that logic is only required when preparing the status report, not for fetching the available release data.

This array is fairly expensive to construct, since it involves a lot of disk I/O, so we cache the results into the \{cache\_\-update\} table using the 'update\_\-project\_\-projects' cache ID. However, since this is not the data about available updates fetched from the network, it is acceptable to invalidate it somewhat quickly. If we keep this data for very long, site administrators are more likely to see incorrect results if they upgrade to a newer version of a module or theme but do not visit certain pages that automatically clear this cache.

\begin{DoxyReturn}{Returns}
An associative array of currently enabled projects keyed by the machine-\/readable project short name. Each project contains:
\begin{DoxyItemize}
\item name: The machine-\/readable project short name.
\item info: An array with values from the main .info file for this project.
\begin{DoxyItemize}
\item name: The human-\/readable name of the project.
\item package: The package that the project is grouped under.
\item version: The version of the project.
\item project: The Drupal.org project name.
\item datestamp: The date stamp of the project's main .info file.
\item \_\-info\_\-file\_\-ctime: The maximum file change time for all of the .info files included in this project.
\end{DoxyItemize}
\item datestamp: The date stamp when the project was released, if known.
\item includes: An associative array containing all projects included with this project, keyed by the machine-\/readable short name with the human-\/readable name as value.
\item project\_\-type: The type of project. Allowed values are 'module' and 'theme'.
\item project\_\-status: This indicates if the project is enabled and will always be TRUE, as the function only returns enabled projects.
\item sub\_\-themes: If the project is a theme it contains an associative array of all sub-\/themes.
\item base\_\-themes: If the project is a theme it contains an associative array of all base-\/themes.
\end{DoxyItemize}
\end{DoxyReturn}
\begin{DoxySeeAlso}{See also}
\hyperlink{update_8compare_8inc_ad14173209d3e9cf76fbd6d6d1977de05}{update\_\-process\_\-project\_\-info()} 

\hyperlink{update_8compare_8inc_aa0663304dc4634e4109c896f214ea791}{update\_\-calculate\_\-project\_\-data()} 

\hyperlink{update_8compare_8inc_a958705ecce49b020722280decff3f644}{update\_\-project\_\-cache()} 
\end{DoxySeeAlso}
\hypertarget{update_8compare_8inc_ad14173209d3e9cf76fbd6d6d1977de05}{
\index{update.compare.inc@{update.compare.inc}!update\_\-process\_\-project\_\-info@{update\_\-process\_\-project\_\-info}}
\index{update\_\-process\_\-project\_\-info@{update\_\-process\_\-project\_\-info}!update.compare.inc@{update.compare.inc}}
\subsubsection[{update\_\-process\_\-project\_\-info}]{\setlength{\rightskip}{0pt plus 5cm}update\_\-process\_\-project\_\-info (\&\$ {\em projects})}}
\label{update_8compare_8inc_ad14173209d3e9cf76fbd6d6d1977de05}
Determines version and type information for currently installed projects.

Processes the list of projects on the system to figure out the currently installed versions, and other information that is required before we can compare against the available releases to produce the status report.


\begin{DoxyParams}{Parameters}
\item[{\em \$projects}]Array of project information from \hyperlink{update_8compare_8inc_a7e1ea49d91f2d2b81b8101d481d10300}{update\_\-get\_\-projects()}. \end{DoxyParams}
\hypertarget{update_8compare_8inc_a958705ecce49b020722280decff3f644}{
\index{update.compare.inc@{update.compare.inc}!update\_\-project\_\-cache@{update\_\-project\_\-cache}}
\index{update\_\-project\_\-cache@{update\_\-project\_\-cache}!update.compare.inc@{update.compare.inc}}
\subsubsection[{update\_\-project\_\-cache}]{\setlength{\rightskip}{0pt plus 5cm}update\_\-project\_\-cache (\$ {\em cid})}}
\label{update_8compare_8inc_a958705ecce49b020722280decff3f644}
Retrieves data from \{cache\_\-update\} or empties the cache when necessary.

Two very expensive arrays computed by this module are the list of all installed modules and themes (and .info data, project associations, etc), and the current status of the site relative to the currently available releases. These two arrays are cached in the \{cache\_\-update\} table and used whenever possible. The cache is cleared whenever the administrator visits the status report, available updates report, or the module or theme administration pages, since we should always recompute the most current values on any of those pages.

Note: while both of these arrays are expensive to compute (in terms of disk I/O and some fairly heavy CPU processing), neither of these is the actual data about available updates that we have to fetch over the network from updates.drupal.org. That information is stored with the 'update\_\-available\_\-releases' cache ID -\/-\/ it needs to persist longer than 1 hour and never get invalidated just by visiting a page on the site.


\begin{DoxyParams}{Parameters}
\item[{\em \$cid}]The cache ID of data to return from the cache. Valid options are 'update\_\-project\_\-data' and 'update\_\-project\_\-projects'.\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The cached value of the \$projects array generated by \hyperlink{update_8compare_8inc_aa0663304dc4634e4109c896f214ea791}{update\_\-calculate\_\-project\_\-data()} or \hyperlink{update_8compare_8inc_a7e1ea49d91f2d2b81b8101d481d10300}{update\_\-get\_\-projects()}, or an empty array when the cache is cleared. 
\end{DoxyReturn}
