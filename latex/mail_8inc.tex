\hypertarget{mail_8inc}{
\section{html/includes/mail.inc File Reference}
\label{mail_8inc}\index{html/includes/mail.inc@{html/includes/mail.inc}}
}
\subsection*{Classes}
\begin{DoxyCompactItemize}
\item 
interface \hyperlink{interfaceMailSystemInterface}{MailSystemInterface}
\end{DoxyCompactItemize}
\subsection*{Enumerations}
\begin{DoxyCompactItemize}
\item 
enum \hyperlink{mail_8inc_a135ed72a6f5c8f9693153def270569d9}{MAIL\_\-LINE\_\-ENDINGS} 
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{mail_8inc_ab80781fd7273975a77cbbd13300eddbf}{drupal\_\-mail} (\$module, \$key, \$to, \$language, \$params=array(), \$from=NULL, \$send=TRUE)
\item 
\hyperlink{mail_8inc_a6ba240b2e368447935c9bcb114f59a1a}{drupal\_\-mail\_\-system} (\$module, \$key)
\item 
\hyperlink{mail_8inc_a955ffecc70c15ab89079ea29557f7b41}{drupal\_\-wrap\_\-mail} (\$text, \$indent= '')
\item 
\hyperlink{mail_8inc_a1d324056cce089d2fc06dedee5b6e92e}{drupal\_\-html\_\-to\_\-text} (\$string, \$allowed\_\-tags=NULL)
\item 
\hyperlink{mail_8inc_a0bd2970cd3a1907c69945f82c22fedbf}{\_\-drupal\_\-wrap\_\-mail\_\-line} (\&\$line, \$key, \$values)
\item 
\hyperlink{mail_8inc_af00e85f84e5f0323c0f2f81ed98b6383}{\_\-drupal\_\-html\_\-to\_\-mail\_\-urls} (\$match=NULL, \$reset=FALSE)
\item 
\hyperlink{mail_8inc_a39b43a9d0ba9add51b67e103c7fbc16e}{\_\-drupal\_\-html\_\-to\_\-text\_\-clean} (\$indent)
\item 
\hyperlink{mail_8inc_a54f26f0265b1eab148753bb7a72c3d09}{\_\-drupal\_\-html\_\-to\_\-text\_\-pad} (\$text, \$pad, \$prefix= '')
\end{DoxyCompactItemize}


\subsection{Detailed Description}
API functions for processing and sending e-\/mail. 

\subsection{Enumeration Type Documentation}
\hypertarget{mail_8inc_a135ed72a6f5c8f9693153def270569d9}{
\index{mail.inc@{mail.inc}!MAIL\_\-LINE\_\-ENDINGS@{MAIL\_\-LINE\_\-ENDINGS}}
\index{MAIL\_\-LINE\_\-ENDINGS@{MAIL\_\-LINE\_\-ENDINGS}!mail.inc@{mail.inc}}
\subsubsection[{MAIL\_\-LINE\_\-ENDINGS}]{\setlength{\rightskip}{0pt plus 5cm}enum {\bf MAIL\_\-LINE\_\-ENDINGS}}}
\label{mail_8inc_a135ed72a6f5c8f9693153def270569d9}
Auto-\/detect appropriate line endings for e-\/mails.

\$conf\mbox{[}'mail\_\-line\_\-endings'\mbox{]} will override this setting. 

\subsection{Function Documentation}
\hypertarget{mail_8inc_af00e85f84e5f0323c0f2f81ed98b6383}{
\index{mail.inc@{mail.inc}!\_\-drupal\_\-html\_\-to\_\-mail\_\-urls@{\_\-drupal\_\-html\_\-to\_\-mail\_\-urls}}
\index{\_\-drupal\_\-html\_\-to\_\-mail\_\-urls@{\_\-drupal\_\-html\_\-to\_\-mail\_\-urls}!mail.inc@{mail.inc}}
\subsubsection[{\_\-drupal\_\-html\_\-to\_\-mail\_\-urls}]{\setlength{\rightskip}{0pt plus 5cm}\_\-drupal\_\-html\_\-to\_\-mail\_\-urls (\$ {\em match} = {\ttfamily NULL}, \/  \$ {\em reset} = {\ttfamily FALSE})}}
\label{mail_8inc_af00e85f84e5f0323c0f2f81ed98b6383}
Keeps track of URLs and replaces them with placeholder tokens.

Callback for preg\_\-replace\_\-callback() within \hyperlink{mail_8inc_a1d324056cce089d2fc06dedee5b6e92e}{drupal\_\-html\_\-to\_\-text()}. \hypertarget{mail_8inc_a39b43a9d0ba9add51b67e103c7fbc16e}{
\index{mail.inc@{mail.inc}!\_\-drupal\_\-html\_\-to\_\-text\_\-clean@{\_\-drupal\_\-html\_\-to\_\-text\_\-clean}}
\index{\_\-drupal\_\-html\_\-to\_\-text\_\-clean@{\_\-drupal\_\-html\_\-to\_\-text\_\-clean}!mail.inc@{mail.inc}}
\subsubsection[{\_\-drupal\_\-html\_\-to\_\-text\_\-clean}]{\setlength{\rightskip}{0pt plus 5cm}\_\-drupal\_\-html\_\-to\_\-text\_\-clean (\$ {\em indent})}}
\label{mail_8inc_a39b43a9d0ba9add51b67e103c7fbc16e}
Replaces non-\/quotation markers from a given piece of indentation with spaces.

Callback for array\_\-map() within \hyperlink{mail_8inc_a1d324056cce089d2fc06dedee5b6e92e}{drupal\_\-html\_\-to\_\-text()}. \hypertarget{mail_8inc_a54f26f0265b1eab148753bb7a72c3d09}{
\index{mail.inc@{mail.inc}!\_\-drupal\_\-html\_\-to\_\-text\_\-pad@{\_\-drupal\_\-html\_\-to\_\-text\_\-pad}}
\index{\_\-drupal\_\-html\_\-to\_\-text\_\-pad@{\_\-drupal\_\-html\_\-to\_\-text\_\-pad}!mail.inc@{mail.inc}}
\subsubsection[{\_\-drupal\_\-html\_\-to\_\-text\_\-pad}]{\setlength{\rightskip}{0pt plus 5cm}\_\-drupal\_\-html\_\-to\_\-text\_\-pad (\$ {\em text}, \/  \$ {\em pad}, \/  \$ {\em prefix} = {\ttfamily ''})}}
\label{mail_8inc_a54f26f0265b1eab148753bb7a72c3d09}
Pads the last line with the given character.

\begin{DoxySeeAlso}{See also}
\hyperlink{mail_8inc_a1d324056cce089d2fc06dedee5b6e92e}{drupal\_\-html\_\-to\_\-text()} 
\end{DoxySeeAlso}
\hypertarget{mail_8inc_a0bd2970cd3a1907c69945f82c22fedbf}{
\index{mail.inc@{mail.inc}!\_\-drupal\_\-wrap\_\-mail\_\-line@{\_\-drupal\_\-wrap\_\-mail\_\-line}}
\index{\_\-drupal\_\-wrap\_\-mail\_\-line@{\_\-drupal\_\-wrap\_\-mail\_\-line}!mail.inc@{mail.inc}}
\subsubsection[{\_\-drupal\_\-wrap\_\-mail\_\-line}]{\setlength{\rightskip}{0pt plus 5cm}\_\-drupal\_\-wrap\_\-mail\_\-line (\&\$ {\em line}, \/  \$ {\em key}, \/  \$ {\em values})}}
\label{mail_8inc_a0bd2970cd3a1907c69945f82c22fedbf}
Wraps words on a single line.

Callback for array\_\-walk() winthin \hyperlink{mail_8inc_a955ffecc70c15ab89079ea29557f7b41}{drupal\_\-wrap\_\-mail()}. \hypertarget{mail_8inc_a1d324056cce089d2fc06dedee5b6e92e}{
\index{mail.inc@{mail.inc}!drupal\_\-html\_\-to\_\-text@{drupal\_\-html\_\-to\_\-text}}
\index{drupal\_\-html\_\-to\_\-text@{drupal\_\-html\_\-to\_\-text}!mail.inc@{mail.inc}}
\subsubsection[{drupal\_\-html\_\-to\_\-text}]{\setlength{\rightskip}{0pt plus 5cm}drupal\_\-html\_\-to\_\-text (\$ {\em string}, \/  \$ {\em allowed\_\-tags} = {\ttfamily NULL})}}
\label{mail_8inc_a1d324056cce089d2fc06dedee5b6e92e}
Transforms an HTML string into plain text, preserving its structure.

The output will be suitable for use as 'format=flowed; delsp=yes' text (RFC 3676) and can be passed directly to \hyperlink{mail_8inc_ab80781fd7273975a77cbbd13300eddbf}{drupal\_\-mail()} for sending.

We deliberately use LF rather than CRLF, see \hyperlink{mail_8inc_ab80781fd7273975a77cbbd13300eddbf}{drupal\_\-mail()}.

This function provides suitable alternatives for the following tags:  {\itshape  {\itshape  {\bfseries  {\bfseries  \par
 }}\/}\/}

{\itshape {\itshape {\bfseries {\bfseries  $<$blockquote$>$ 
\begin{DoxyItemize}
\end{DoxyItemize}
\begin{DoxyEnumerate}
\item 
\begin{DoxyDescription}
\item[]\subsection*{\$string The string to be transformed.  \$allowed\_\-tags (optional) If supplied, a list of tags that will be transformed. If omitted, all all supported tags are transformed.   The transformed string. }


\end{DoxyDescription}
\end{DoxyEnumerate}}}\/}\/}\hypertarget{mail_8inc_ab80781fd7273975a77cbbd13300eddbf}{
\index{mail.inc@{mail.inc}!drupal\_\-mail@{drupal\_\-mail}}
\index{drupal\_\-mail@{drupal\_\-mail}!mail.inc@{mail.inc}}
\subsubsection[{drupal\_\-mail}]{\setlength{\rightskip}{0pt plus 5cm}drupal\_\-mail (\$ {\em module}, \/  \$ {\em key}, \/  \$ {\em to}, \/  \$ {\em language}, \/  \$ {\em params} = {\ttfamily array()}, \/  \$ {\em from} = {\ttfamily NULL}, \/  \$ {\em send} = {\ttfamily TRUE})}}
\label{mail_8inc_ab80781fd7273975a77cbbd13300eddbf}
Composes and optionally sends an e-\/mail message.

Sending an e-\/mail works with defining an e-\/mail template (subject, text and possibly e-\/mail headers) and the replacement values to use in the appropriate places in the template. Processed e-\/mail templates are requested from \hyperlink{group__hooks_gacdeb1cba0d0a86ac4de3fff7d4765777}{hook\_\-mail()} from the module sending the e-\/mail. Any module can modify the composed e-\/mail message array using \hyperlink{group__hooks_gaad1d55a8e7b359933f462a9ca5b2ede0}{hook\_\-mail\_\-alter()}. Finally \hyperlink{mail_8inc_a6ba240b2e368447935c9bcb114f59a1a}{drupal\_\-mail\_\-system()}-\/$>$mail() sends the e-\/mail, which can be reused if the exact same composed e-\/mail is to be sent to multiple recipients.

Finding out what language to send the e-\/mail with needs some consideration. If you send e-\/mail to a user, her preferred language should be fine, so use \hyperlink{user_8module_a0122ed84b87c9b23dbd3be7ff563bc49}{user\_\-preferred\_\-language()}. If you send email based on form values filled on the page, there are two additional choices if you are not sending the e-\/mail to a user on the site. You can either use the language used to generate the page (\$language global variable) or the site default language. See \hyperlink{bootstrap_8inc_a336c0878074791056c62640cd95d8067}{language\_\-default()}. The former is good if sending e-\/mail to the person filling the form, the later is good if you send e-\/mail to an address previously set up (like contact addresses in a contact form).

Taking care of always using the proper language is even more important when sending e-\/mails in a row to multiple users. Hook\_\-mail() abstracts whether the mail text comes from an administrator setting or is static in the source code. It should also deal with common mail tokens, only receiving \$params which are unique to the actual e-\/mail at hand.

An example:


\begin{DoxyCode}
   function example_notify($accounts) {
     foreach ($accounts as $account) {
       $params['account'] = $account;
       // example_mail() will be called based on the first drupal_mail() paramete
      r.
       drupal_mail('example', 'notice', $account->mail, user_preferred_language($
      account), $params);
     }
   }

   function example_mail($key, &$message, $params) {
     $data['user'] = $params['account'];
     $options['language'] = $message['language'];
     user_mail_tokens($variables, $data, $options);
     switch($key) {
       case 'notice':
         // If the recipient can receive such notices by instant-message, do
         // not send by email.
         if (example_im_send($key, $message, $params)) {
           $message['send'] = FALSE;
           break;
         }
         $langcode = $message['language']->language;
         $message['subject'] = t('Notification from !site', $variables, array('la
      ngcode' => $langcode));
         $message['body'][] = t("Dear !username\n\nThere is new content available
       on the site.", $variables, array('langcode' => $langcode));
         break;
     }
   }
\end{DoxyCode}


Another example, which uses \hyperlink{mail_8inc_ab80781fd7273975a77cbbd13300eddbf}{drupal\_\-mail()} to format a message for sending later:


\begin{DoxyCode}
   $params = array('current_conditions' => $data);
   $to = 'user@example.com';
   $message = drupal_mail('example', 'notice', $to, $language, $params, FALSE);
   // Only add to the spool if sending was not canceled.
   if ($message['send']) {
     example_spool_message($message);
   }
\end{DoxyCode}



\begin{DoxyParams}{Parameters}
\item[{\em \$module}]A module name to invoke \hyperlink{group__hooks_gacdeb1cba0d0a86ac4de3fff7d4765777}{hook\_\-mail()} on. The \{\$module\}\_\-mail() hook will be called to complete the \$message structure which will already contain common defaults. \item[{\em \$key}]A key to identify the e-\/mail sent. The final e-\/mail id for e-\/mail altering will be \{\$module\}\_\-\{\$key\}. \item[{\em \$to}]The e-\/mail address or addresses where the message will be sent to. The formatting of this string will be validated with the \hyperlink{}{PHP e-\/mail validation filter. } Some examples are:
\begin{DoxyItemize}
\item \href{mailto:user@example.com}{\tt user@example.com}
\item \href{mailto:user@example.com}{\tt user@example.com}, \href{mailto:anotheruser@example.com}{\tt anotheruser@example.com}
\item User $<$\href{mailto:user@example.com}{\tt user@example.com}$>$
\item User $<$\href{mailto:user@example.com}{\tt user@example.com}$>$, Another User $<$\href{mailto:anotheruser@example.com}{\tt anotheruser@example.com}$>$ 
\end{DoxyItemize}\item[{\em \$language}]Language object to use to compose the e-\/mail. \item[{\em \$params}]Optional parameters to build the e-\/mail. \item[{\em \$from}]Sets From to this value, if given. \item[{\em \$send}]If TRUE, \hyperlink{mail_8inc_ab80781fd7273975a77cbbd13300eddbf}{drupal\_\-mail()} will call \hyperlink{mail_8inc_a6ba240b2e368447935c9bcb114f59a1a}{drupal\_\-mail\_\-system()}-\/$>$mail() to deliver the message, and store the result in \$message\mbox{[}'result'\mbox{]}. Modules implementing \hyperlink{group__hooks_gaad1d55a8e7b359933f462a9ca5b2ede0}{hook\_\-mail\_\-alter()} may cancel sending by setting \$message\mbox{[}'send'\mbox{]} to FALSE.\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The \$message array structure containing all details of the message. If already sent (\$send = TRUE), then the 'result' element will contain the success indicator of the e-\/mail, failure being already written to the watchdog. (Success means nothing more than the message being accepted at php-\/level, which still doesn't guarantee it to be delivered.) 
\end{DoxyReturn}
\hypertarget{mail_8inc_a6ba240b2e368447935c9bcb114f59a1a}{
\index{mail.inc@{mail.inc}!drupal\_\-mail\_\-system@{drupal\_\-mail\_\-system}}
\index{drupal\_\-mail\_\-system@{drupal\_\-mail\_\-system}!mail.inc@{mail.inc}}
\subsubsection[{drupal\_\-mail\_\-system}]{\setlength{\rightskip}{0pt plus 5cm}drupal\_\-mail\_\-system (\$ {\em module}, \/  \$ {\em key})}}
\label{mail_8inc_a6ba240b2e368447935c9bcb114f59a1a}
Returns an object that implements the \hyperlink{interfaceMailSystemInterface}{MailSystemInterface} interface.

Allows for one or more custom mail backends to format and send mail messages composed using \hyperlink{mail_8inc_ab80781fd7273975a77cbbd13300eddbf}{drupal\_\-mail()}.

An implementation needs to implement the following methods:
\begin{DoxyItemize}
\item format: Allows to preprocess, format, and postprocess a mail message before it is passed to the sending system. By default, all messages may contain HTML and are converted to plain-\/text by the \hyperlink{classDefaultMailSystem}{DefaultMailSystem} implementation. For example, an alternative implementation could override the default implementation and additionally sanitize the HTML for usage in a MIME-\/encoded e-\/mail, but still invoking the \hyperlink{classDefaultMailSystem}{DefaultMailSystem} implementation to generate an alternate plain-\/text version for sending.
\item mail: Sends a message through a custom mail sending engine. By default, all messages are sent via PHP's mail() function by the \hyperlink{classDefaultMailSystem}{DefaultMailSystem} implementation.
\end{DoxyItemize}

The selection of a particular implementation is controlled via the variable 'mail\_\-system', which is a keyed array. The default implementation is the class whose name is the value of 'default-\/system' key. A more specific match first to key and then to module will be used in preference to the default. To specify a different class for all mail sent by one module, set the class name as the value for the key corresponding to the module name. To specify a class for a particular message sent by one module, set the class name as the value for the array key that is the message id, which is \char`\"{}\$\{module\}\_\-\$\{key\}\char`\"{}.

For example to debug all mail sent by the user module by logging it to a file, you might set the variable as something like:


\begin{DoxyCode}
 array(
   'default-system' => 'DefaultMailSystem',
   'user' => 'DevelMailLog',
 );
\end{DoxyCode}


Finally, a different system can be specified for a specific e-\/mail ID (see the \$key param), such as one of the keys used by the contact module:


\begin{DoxyCode}
 array(
   'default-system' => 'DefaultMailSystem',
   'user' => 'DevelMailLog',
   'contact_page_autoreply' => 'DrupalDevNullMailSend',
 );
\end{DoxyCode}


Other possible uses for system include a mail-\/sending class that actually sends (or duplicates) each message to SMS, Twitter, instant message, etc, or a class that queues up a large number of messages for more efficient bulk sending or for sending via a remote gateway so as to reduce the load on the local server.


\begin{DoxyParams}{Parameters}
\item[{\em \$module}]The module name which was used by \hyperlink{mail_8inc_ab80781fd7273975a77cbbd13300eddbf}{drupal\_\-mail()} to invoke \hyperlink{group__hooks_gacdeb1cba0d0a86ac4de3fff7d4765777}{hook\_\-mail()}. \item[{\em \$key}]A key to identify the e-\/mail sent. The final e-\/mail ID for the e-\/mail alter hook in \hyperlink{mail_8inc_ab80781fd7273975a77cbbd13300eddbf}{drupal\_\-mail()} would have been \{\$module\}\_\-\{\$key\}.\end{DoxyParams}
\begin{DoxyReturn}{Returns}
\hyperlink{interfaceMailSystemInterface}{MailSystemInterface} 
\end{DoxyReturn}
\hypertarget{mail_8inc_a955ffecc70c15ab89079ea29557f7b41}{
\index{mail.inc@{mail.inc}!drupal\_\-wrap\_\-mail@{drupal\_\-wrap\_\-mail}}
\index{drupal\_\-wrap\_\-mail@{drupal\_\-wrap\_\-mail}!mail.inc@{mail.inc}}
\subsubsection[{drupal\_\-wrap\_\-mail}]{\setlength{\rightskip}{0pt plus 5cm}drupal\_\-wrap\_\-mail (\$ {\em text}, \/  \$ {\em indent} = {\ttfamily ''})}}
\label{mail_8inc_a955ffecc70c15ab89079ea29557f7b41}
Performs format=flowed soft wrapping for mail (RFC 3676).

We use delsp=yes wrapping, but only break non-\/spaced languages when absolutely necessary to avoid compatibility issues.

We deliberately use LF rather than CRLF, see \hyperlink{mail_8inc_ab80781fd7273975a77cbbd13300eddbf}{drupal\_\-mail()}.


\begin{DoxyParams}{Parameters}
\item[{\em \$text}]The plain text to process. \item[{\em \$indent}](optional) A string to indent the text with. Only '$>$' characters are repeated on subsequent wrapped lines. Others are replaced by spaces.\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The content of the email as a string with formatting applied. 
\end{DoxyReturn}
