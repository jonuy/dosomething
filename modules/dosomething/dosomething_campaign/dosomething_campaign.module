<?php
/**
 * @file
 * Code for the dosomething_campaign feature.
 */

include_once 'dosomething_campaign.features.inc';

/**
 * Implements hook_form_alter().
 */
function dosomething_campaign_form_campaign_node_form_alter(&$form, &$form_state, $form_id) {
  // Include the CTools tools that we need.
  ctools_include('ajax');
  ctools_include('modal');
  // Add CTools' javascript to the page.
  ctools_modal_add_js();
  // Link for the ctools modal page to render.
  $add_fact_link = 'admin/dosomething-fact/modal-add/nojs';

  $add_link_div = '<div id="add-fact-status"></div><div>' . l(t('Add new fact'), $add_fact_link, array('attributes' => array('class' => 'ctools-use-modal'))) . '</div>';

  $form['field_fact_problem']['#prefix'] = $add_link_div;
  unset($form['field_active_hours'][LANGUAGE_NONE]['#options']['_none']);
}

/**
 * Implements hook_menu().
 */
function dosomething_campaign_menu() {
  $items = array();

  // node/nid/pitch
  $items['node/%node/pitch'] = array(
    'title callback' => '_dosomething_campaign_page_title',
    'title arguments' => array(1),
    'page callback' => '_dosomething_campaign_pitch_view_mode',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}
/**
 * Campaign title callback from hook_menu().
 */
function _dosomething_campaign_page_title($node) {
  return 'Pitch ' . $node->title;
}

/**
 * Campaign pitch page callback from hook_menu().
 */
function _dosomething_campaign_pitch_view_mode($node) {
  $node_rendered = node_view($node, 'pitch');
  return $node_rendered;
}

/**
 * Implements hook_entity_info_alter().
 */
function dosomething_campaign_entity_info_alter(&$entity_info) {
  $entity_info['node']['view modes']['pitch'] = array(
    'label' => t('Pitch page'),
    'custom settings' => TRUE,
  );
}

/**
 * Implements hook_preprocess_node().
 */
function dosomething_campaign_preprocess_node(&$vars) {
  if ($vars['view_mode'] == 'pitch') {
    // Use the pitch page template to theme.
    $vars['theme_hook_suggestions'][] = 'node__' . $vars['type'] . '__pitch';

    // Gather vars for pitch page.
    dosomething_campaign_preprocess_pitch_page($vars);
  }
}

/**
 * Preprocess pitch page vars.
 */
function dosomething_campaign_preprocess_pitch_page(&$vars) {
  // Prepare vars for pitch page.
}
